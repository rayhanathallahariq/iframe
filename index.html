<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-language" content="fa" />
    <title>Online signals</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">

    <link rel="stylesheet" href="./Content/style2.css" />
    <link rel="stylesheet" href="./Content/jquery-ui.css" />
    <link rel="stylesheet" href="./Content/plugins/bootstrap-datepicker.min.css" />
    <link rel="stylesheet" href="./Content/plugins/fileinput.min.css" />
    <link rel="stylesheet" href="./Content/site.min.css" />
    <link rel="stylesheet" href="./Content/onliestyles.css" />

    <script src="/Scripts/libs/modernizr-2.8.3.min.js"></script>

    <noscript>
        <meta http-equiv="refresh" content="0;url=/NoScript.html">
    </noscript>
</head>

<body>
    <div id="error-message">
        <section class="page_404">
            <div class="container">
                <div class="row">
                    <div class="col-sm-12 ">
                        <div class="col-sm-10 col-sm-offset-1  text-center">
                            <div class="four_zero_four_bg">
                                <h1 class="text-center ">404</h1>


                            </div>

                            <div class="contant_box_404">
                                <h3 class="h2">
                                    Invalid or missing token. Please provide a valid token in the URL
                                </h3>

                                <p>the page you are looking for not avaible!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="content" style="display: none;">
        <div>
            <!-- Dialogs
        ================================================== -->
            <div class="row">
                <div class="col-md-12 ">


                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-md-15">
                                    <div class="col-md-15">
                                        <div class="container-online">
                                            <div class="waveform-box">
                                                <div class="row">
                                                    <span class="waveform-title ecg-color" id="param_name"
                                                        style="margin-left:20px"> Name:---</span>
                                                    <span class="waveform-title ecg-color" id="param_code"
                                                        style="margin-left:20px"> Code:---</span>
                                                    <span class="waveform-title ecg-color" id="param_wires"
                                                        style="margin-left:20px"> Wires:---</span>
                                                    <span class="waveform-title ecg-color" id="param_lead"
                                                        style="margin-left:20px">Master lead:---</span>
                                                    <span class="waveform-title ecg-color" id="param_notch"
                                                        style="margin-left:20px">Notch filter:---</span>
                                                    <span class="waveform-title ecg-color" id="param_pace"
                                                        style="margin-left:20px">Pace:---</span>
                                                    <span class="waveform-title ecg-color" id="param_gain"
                                                        style="margin-left:20px">Gain:10 mm/mV</span>
                                                    <span class="waveform-title ecg-color" id="param_speed"
                                                        style="margin-left:20px">Speed: 25 mm/s</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-15">

                                    <div class="container-online">

                                        <div class="waveforms-container">
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead I</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-ecg1" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead 2</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-ecg2" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead 3</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-ecg3" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead AVR</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-avr" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead AVL</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-avl" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead AVF</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-avf" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                        </div>

                                        <div class="waveforms-container">
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V1</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v1" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V2</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v2" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V3</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v3" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V4</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v4" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V5</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v5" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                            <div class="waveform-box">
                                                <span class="waveform-title ecg-color">Lead V6</span>
                                                <canvas class="grid-canvas" width="840px" height="150px"></canvas>
                                                <canvas class="waveform" id="waveform-v6" width="1400px"
                                                    height="185px"></canvas>
                                            </div>
                                        </div>

                                        <div class="parameters-container">
                                            <div class="parameter-box">
                                                <div class="parameter-header">
                                                    <span class="parameter-title ecg-color">HR(bpm)</span>
                                                    <span class="parameter-valueHR ecg-color"
                                                        id="parameter-heart-rate">---</span>
                                                </div>
                                                <div class="patient-info">
                                                    <span class="info-item ecg-color" id="device-code">Device Code:
                                                        ---</span>
                                                    <span class="info-item ecg-color" id="patient-age">Age: ---</span>
                                                    <span class="info-item ecg-color" id="patient-name">Patient
                                                        ---</span>
                                                    <span class="info-item ecg-color" id="patient-age">Age: ---</span>
                                                    <span class="info-item ecg-color" id="patient-gender">Gender:
                                                        ---</span>
                                                    <span class="info-item ecg-color"
                                                        id="patient-national-code">National
                                                        Code:
                                                        ---</span>
                                                </div>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title nibp-color">NIBP(mmHg)</span>
                                                <span class="parameter-value2 nibp-color"
                                                    id="parameter-nibp">---/---(---)</span>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title spo2-color">SpO2(%)</span>
                                                <span class="parameter-value spo2-color" id="parameter-spo2">---</span>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title spo2-color">PR(bpm)</span>
                                                <span class="parameter-value spo2-color"
                                                    id="parameter-pulse-rate">---</span>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title temperature-color">Temp1(°C)</span>
                                                <span class="parameter-value temperature-color"
                                                    id="parameter-temperature1">---</span>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title temperature-color">Temp2(°C)</span>
                                                <span class="parameter-value temperature-color"
                                                    id="parameter-temperature2">---</span>
                                            </div>

                                            <div class="parameter-box">
                                                <span class="parameter-title resp-color">RESP(brpm)</span>
                                                <span class="parameter-value resp-color"
                                                    id="parameter-resp-rate">---</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
        <div class="modal  fade in" id="modal" tabindex="-1" data-keyboard="false" data-backdrop="static" role="dialog"
            aria-hidden="true">
        </div>
    </div>
    <script src="./Scripts/jquery-1.12.4.js"></script>
    <script src="./Scripts/libs/jquery.unobtrusive-ajax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script src="./Scripts/libs/bootstrap.min.js"></script>
    <script src="./Scripts/libs/respond.min.js"></script>
    <script src="./Scripts/plugins/jquery.noty.packaged.min.js"></script>
    <script src="./Scripts/plugins/jquery.dlmenu.min.js"></script>
    <script src="./Scripts/plugins/masonry.pkgd.min.js"></script>
    <script src="./Scripts/plugins/jquery.mvc.deleteItem.min.js"></script>
    <script src="./Scripts/plugins/jquery.mvc.asyncLoad.min.js"></script>
    <script src="./Scripts/plugins/jquery.mvc.scan.min.js"></script>
    <script src="./Scripts/plugins/jquery.mvc.getJson.min.js"></script>
    <script src="./Scripts/customs/noty.alerts.min.js"></script>
    <script src="./Scripts/customs/ajax.methods.min.js"></script>
    <script src="./Scripts/plugins/fileinput.min.js"></script>
    <script src="./Scripts/plugins/jquery.farsiInput.min.js"></script>
    <script src="./Scripts/customs/site.min.js"></script>
    <script src="./Scripts/online/ecg-waveform.js"></script>

    <script>
        const waveformECG1 = new EcgWaveform(document.getElementById('waveform-ecg1'), 'green', 1900, 0.6, 25);
        const waveformECG2 = new EcgWaveform(document.getElementById('waveform-ecg2'), 'green', 1900, 0.6, 25);
        const waveformECG3 = new EcgWaveform(document.getElementById('waveform-ecg3'), 'green', 1900, 0.6, 25);
        const waveformECG4 = new EcgWaveform(document.getElementById('waveform-avr'), 'green', 1900, 0.6, 25);
        const waveformECG5 = new EcgWaveform(document.getElementById('waveform-avl'), 'green', 1900, 0.6, 25);
        const waveformECG6 = new EcgWaveform(document.getElementById('waveform-avf'), 'green', 1900, 0.6, 25);
        const waveformECG7 = new EcgWaveform(document.getElementById('waveform-v1'), 'green', 1900, 0.6, 25);
        const waveformECG8 = new EcgWaveform(document.getElementById('waveform-v2'), 'green', 1900, 0.6, 25);
        const waveformECG9 = new EcgWaveform(document.getElementById('waveform-v3'), 'green', 1900, 0.6, 25)
        const waveformECG10 = new EcgWaveform(document.getElementById('waveform-v4'), 'green', 1900, 0.6, 25);
        const waveformECG11 = new EcgWaveform(document.getElementById('waveform-v5'), 'green', 1900, 0.6, 25);
        const waveformECG12 = new EcgWaveform(document.getElementById('waveform-v6'), 'green', 1900, 0.6, 25);

        const paramHeartRate = document.getElementById('parameter-heart-rate');
        const paramNIBP = document.getElementById('parameter-nibp');
        const paramSpO2 = document.getElementById('parameter-spo2');
        const paramPulseRate = document.getElementById('parameter-pulse-rate');
        const paramTemperature1 = document.getElementById('parameter-temperature1');
        const paramTemperature2 = document.getElementById('parameter-temperature2');
        const paramRespRate = document.getElementById('parameter-resp-rate');

        const param_name = document.getElementById('param_name');
        const param_code = document.getElementById('param_code');

        const param_wires = document.getElementById('param_wires');
        const param_lead = document.getElementById('param_lead');
        const param_notch = document.getElementById('param_notch');
        const param_pace = document.getElementById('param_pace');
        const param_gain = document.getElementById('param_gain');
        const param_speed = document.getElementById('param_speed');


        var ecgWaveformBuf1 = [];
        var ecgWaveformBuf2 = [];
        var ecgWaveformBuf3 = [];
        var ecgWaveformBuf4 = [];
        var ecgWaveformBuf5 = [];
        var ecgWaveformBuf6 = [];
        var ecgWaveformBuf7 = [];
        var ecgWaveformBuf8 = [];
        var ecgWaveformBuf9 = [];
        var ecgWaveformBuf10 = [];
        var ecgWaveformBuf11 = [];
        var ecgWaveformBuf12 = [];

        var waveforms = [
            { "waveform": waveformECG1, "buffer": ecgWaveformBuf1, "slice_size": 10 },
            { "waveform": waveformECG2, "buffer": ecgWaveformBuf2, "slice_size": 10 },
            { "waveform": waveformECG3, "buffer": ecgWaveformBuf3, "slice_size": 10 },
            { "waveform": waveformECG4, "buffer": ecgWaveformBuf4, "slice_size": 10 },
            { "waveform": waveformECG5, "buffer": ecgWaveformBuf5, "slice_size": 10 },
            { "waveform": waveformECG6, "buffer": ecgWaveformBuf6, "slice_size": 10 },
            { "waveform": waveformECG7, "buffer": ecgWaveformBuf7, "slice_size": 10 },
            { "waveform": waveformECG8, "buffer": ecgWaveformBuf8, "slice_size": 10 },
            { "waveform": waveformECG9, "buffer": ecgWaveformBuf9, "slice_size": 10 },
            { "waveform": waveformECG10, "buffer": ecgWaveformBuf10, "slice_size": 10 },
            { "waveform": waveformECG11, "buffer": ecgWaveformBuf11, "slice_size": 10 },
            { "waveform": waveformECG12, "buffer": ecgWaveformBuf12, "slice_size": 10 },
        ];
        window.onload = initdocument;


        window.addEventListener('beforeunload', (e) => {
            e.preventDefault()
            return (e.returnValue = 'Are you sure you want to close?')
        })

        async function initdocument() {
            var wsUri = "wss://monitoring.telehealth.universal-iot.com:443/web";
            websocket = new WebSocket(wsUri);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
            websocket.onerror = onError;

            setInterval(updateWaveforms, 40);
            setInterval(aliveHandShake, 10000);
        }

        window.onload = initdocument;

        const authServerUrl = "https://monitoring.telehealth.universal-iot.com/api/chronos/GetToken";

        window.jwtToken = '';

        async function getJwtToken() {
            try {
                const response = await axios.post(authServerUrl, {
                    username: "user1",
                    password: "User1!1234",
                }, {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                window.jwtToken = response.data.Data;
                return window.jwtToken;
            } catch (error) {
                console.error("Error getting JWT token:", error);
                return null;
            }
        }

        async function onOpen(evt) {
            try {
                await getJwtToken();
                if (window.jwtToken) {
                    let arg = 2123 + "," + 55975275 + "," + 0 + "," + window.jwtToken;
                    doSend(arg);
                } else {
                    console.error("Failed to get JWT token");
                }
            } catch (error) {
                console.error("Error in onOpen:", error);
            }
        }

        function onClose(evt) {
            websocket = null;
            // alert("DISCONNECTED");
        }
        var lastOrder = -1;
        function drawECGGrid() {
            const gridCanvases = document.querySelectorAll('.grid-canvas');

            gridCanvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                // Clear canvas
                ctx.clearRect(0, 0, width, height);

                // Set grid line styles
                ctx.strokeStyle = '#FF000020';  // Light red color
                ctx.lineWidth = 2;

                // Draw vertical lines
                for (let x = 0; x <= width; x += 35) {  // 35px is 1mm at 25mm/s
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();

                    // Draw darker line every 5mm
                    if (x % 175 === 0) {
                        ctx.strokeStyle = 'red';
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, height);
                        ctx.stroke();
                        ctx.strokeStyle = '#FF000020';
                    }
                }

                // Draw horizontal lines
                for (let y = 0; y <= height; y += 37) {  // 37px is 1mV at 10mm/mV
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();

                    // Draw darker line every 5mm
                    if (y % 185 === 0) {
                        ctx.strokeStyle = '#FF000020';
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(width, y);
                        ctx.stroke();
                        ctx.strokeStyle = '#FF000020';
                    }
                }
            });
        }
        function onMessage(evt) {
            const obj = JSON.parse(evt.data);
            console.log(obj);
            if (lastOrder == -1 || obj.Order == 0) {
                lastOrder = obj.Order
            }
            else {
                if (!(obj.Order == (lastOrder + 1)) && obj.Order > 0) {
                    for (let i = 0; i < 10; i++) {
                        ecgWaveformBuf1.push(0)
                        ecgWaveformBuf2.push(0)
                        ecgWaveformBuf3.push(0)
                        ecgWaveformBuf4.push(0)
                        ecgWaveformBuf5.push(0)
                        ecgWaveformBuf6.push(0)
                        ecgWaveformBuf7.push(0)
                        ecgWaveformBuf8.push(0)
                        ecgWaveformBuf9.push(0)
                        ecgWaveformBuf10.push(0)
                        ecgWaveformBuf11.push(0)
                        ecgWaveformBuf12.push(0)
                    }
                }
            }
            if (obj.Order >= 0)
                lastOrder = obj.Order

            if (obj.Order == -1) {
                paramNIBP.innerHTML = ((obj.NibpSys === '') || (obj.NibpDias === '') || (obj.NibpMean === '')) ? '---/---(---)' : obj.NibpSys + '/' + obj.NibpDias + '(' + obj.NibpMean + ')';

                paramSpO2.innerHTML = (obj.Spo2 === '') ? '---' : obj.Spo2;
                paramPulseRate.innerHTML = (obj.Pr === '') ? '---' : obj.Pr;
                paramTemperature1.innerHTML = (obj.T1 === '') ? '---.-' : obj.T1;
                paramTemperature2.innerHTML = (obj.T2 === '') ? '---.-' : obj.T2;
                param_name.innerHTML = obj.PatientName;
                param_code.innerHTML = obj.PatientNationalId;
                document.getElementById('patient-name').textContent = 'Name: ' + (obj.PatientName || '---');
                document.getElementById('patient-age').textContent = 'Age: ' + (obj.PatientAge || '---');
                document.getElementById('patient-gender').textContent = 'Gender: ' + (obj.PatientGender || '---');
                document.getElementById('patient-national-code').textContent = 'National Code: ' + (obj.PatientNationalId || '---');
                document.getElementById('device-code').textContent = 'Device Code: ' + (obj.DeviceCode || '---');

            }
            else {
                param_wires.innerHTML = (obj.EcgWires === '') ? 'Wires:---' : obj.EcgWires;
                param_notch.innerHTML = (obj.NotchFilter === '') ? 'Notch filter---' : obj.NotchFilter;
                param_pace.innerHTML = (obj.Pace === '') ? 'Pace:---' : obj.Pace;
                // param_gain.innerHTML = (obj.EcgWires === '') ? '---' : obj.EcgWires;
                // param_speed.innerHTML = (obj.Speed === '') ? '---' : obj.Speed;
                param_lead.innerHTML = (obj.MasterLead === '') ? 'Master lead:---' : obj.MasterLead;


                paramHeartRate.innerHTML = (obj.Hr === '') ? '---' : obj.Hr;
                paramRespRate.innerHTML = (obj.Rr === '') ? '---' : obj.Rr;
            }

            let count = 0;
            for (let i = 0; i < obj.Signals.length; i++) {
                if (obj.Signals[i] != null) {
                    count = obj.Signals[i].length;
                    break;
                }
            }
            for (let i = 0; i < count; i++) {
                if (i % 2 == 0) {
                    if (obj.Signals[0] != null && obj.Signals[0].length > 0)
                        ecgWaveformBuf1.push((obj.Signals[0][i] + 950))

                    if (obj.Signals[1] != null && obj.Signals[1].length > 0)
                        ecgWaveformBuf2.push((obj.Signals[1][i] + 950))

                    if (obj.Signals[2] != null && obj.Signals[2].length > 0)
                        ecgWaveformBuf3.push((obj.Signals[2][i] + 950))
                    if (obj.Signals[0] != null && obj.Signals[0].length > 0 && obj.Signals[1] != null && obj.Signals[1].length > 0) {

                        ecgWaveformBuf4.push(-((obj.Signals[0][i] + obj.Signals[1][i]) / 2) + 950)
                        ecgWaveformBuf5.push((obj.Signals[0][i] - obj.Signals[1][i] / 2) + 950)
                        ecgWaveformBuf6.push((obj.Signals[1][i] - obj.Signals[0][i] / 2) + 950)
                    }
                    if (obj.Signals[3] != null && obj.Signals[3].length > 0)
                        ecgWaveformBuf7.push((obj.Signals[3][i] + 950))

                    if (obj.Signals[4] != null && obj.Signals[4].length > 0)
                        ecgWaveformBuf8.push((obj.Signals[4][i] + 950))

                    if (obj.Signals[5] != null && obj.Signals[5].length > 0)
                        ecgWaveformBuf9.push((obj.Signals[5][i] + 950))

                    if (obj.Signals[6] != null && obj.Signals[6].length > 0)
                        ecgWaveformBuf10.push((obj.Signals[6][i] + 950))

                    if (obj.Signals[7] != null && obj.Signals[7].length > 0)
                        ecgWaveformBuf11.push((obj.Signals[7][i] + 950))

                    if (obj.Signals[8] != null && obj.Signals[8].length > 0)
                        ecgWaveformBuf12.push((obj.Signals[8][i] + 950))
                }
            }
        }

        function onError(evt) {
            // alert("error");
        }

        function doSend(message) {
            // alert("SENT: " + message);
            websocket.send(message);
        }

        async function aliveHandShake() {
            if (websocket == null) {
                await initdocument();
            } else {
                if (window.jwtToken) {
                    websocket.send("Hi," + window.jwtToken);
                } else {
                    await getJwtToken();
                    if (window.jwtToken) {
                        websocket.send("Hi," + window.jwtToken);
                    } else {
                        console.error("Failed to get JWT token for aliveHandShake");
                    }
                }
            }
        }

        function setupTokenRefresh() {
            // Refresh token every 55 minutes (assuming token expires in 1 hour)
            setInterval(async () => {
                await getJwtToken();
            }, 55 * 60 * 1000);
        }
        const authParams = "https://api.telemedicine.universal-iot.com/rest-uiot/v-1/telemedicine/auth/login"

        function updateUrlWithToken() {
            const url = new URL(window.location);
            url.searchParams.set('token', tokenParams);
            window.history.replaceState(null, '', url.toString());
        }

        function updateUrlWithValidToken() {
            const url = new URL(window.location);
            url.searchParams.set('token', validToken);
            window.history.replaceState(null, '', url.toString());
        }

        let validToken = "";
        async function getTokenParams() {
            try {
                const response = await axios.post(authParams, {
                    email: "bily@contoh.com",
                    password: "secret",
                }, {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                validToken = response.data.data.token;
                console.log("Token received:", validToken);
                updateUrlWithValidToken();
                return validToken;
            } catch (error) {
                console.error("Error getting JWT token:", error);
                return null;
            }
        }

        function checkAndSetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');

            if (urlToken === validToken) {
                document.getElementById('content').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
                return true;
            } else {
                document.getElementById('content').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                return false;
            }
        }

        window.onload = async function () {
            await getTokenParams();
            checkAndSetToken();

            if (document.getElementById('content').style.display !== 'none') {
                initdocument();
                setupTokenRefresh();
                drawECGGrid();
            }
        };

        function updateWaveforms() {
            if (document.hidden) {
                for (let waveform of waveforms) {
                    waveform["waveform"].addArray(waveform["buffer"].splice(0, waveform["buffer"].length));
                }
            }
            else {
                for (let waveform of waveforms) {
                    if (waveform["buffer"].length > 12) {
                        waveform["waveform"].addArray(waveform["buffer"].splice(0, 12));
                    }
                    else if (waveform["buffer"].length > waveform["slice_size"]) {
                        waveform["waveform"].addArray(waveform["buffer"].splice(0, waveform["slice_size"]));
                    }

                }
            }

        }


    </script>

    <style>
        /*======================
    404 page
=======================*/


        .page_404 {
            padding: 40px 0;
            background: #fff;
            font-family: 'Arvo', serif;
        }

        .page_404 img {
            width: 100%;
        }

        .four_zero_four_bg {

            background-image: url(https://cdn.dribbble.com/users/285475/screenshots/2083086/dribbble_1.gif);
            height: 400px;
            background-position: center;
        }


        .four_zero_four_bg h1 {
            font-size: 80px;
        }

        .four_zero_four_bg h3 {
            font-size: 80px;
        }

        .link_404 {
            color: #fff !important;
            padding: 10px 20px;
            background: #39ac31;
            margin: 20px 0;
            display: inline-block;
        }

        .contant_box_404 {
            margin-top: -50px;
        }
    </style>
</body>

</html>